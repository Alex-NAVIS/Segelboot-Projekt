<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Einstellungen</title>

  <style>
    body { background:#001d26; color:#fff; font-family:sans-serif; text-align:center; padding:20px; line-height: 1.4; }
    h1 { color:#00bcd4; }
    h2 { color:#00bcd4; margin-top:25px; }

    table { margin:20px auto; border-collapse:collapse; width:90%; max-width:700px; }
    th, td { border:1px solid #007d91; padding:10px; text-align: left; }
    th { background: #002b3a; color: #00bcd4; text-align: center; }
    
    .info-text { font-size: 0.85em; color: #ccc; margin-top: 4px; display: block; }
    
    input[type="number"], input[type="text"] {
      width:100%;
      box-sizing: border-box;
      background:#002b3a;
      color:#fff;
      border:1px solid #007d91;
      padding:6px;
    }
    input[type="checkbox"] { transform: scale(1.2); margin-right:8px; }

    .buttonBar { margin-top:30px; padding: 20px; border-top: 1px solid #007d91; }
    button {
      margin:5px;
      padding:12px 20px;
      font-size:15px;
      font-weight: bold;
      border:none;
      border-radius:8px;
      cursor:pointer;
      min-width: 180px;
    }
    #saveBtn { background:#00bcd4; color:#000; }
    #cancelBtn { background:#444; color:#fff; }
    #calibCompassBtn { background:#ff9800; color:#000; } 
    #calibGyroBtn { background:#f44336; color:#fff; }    
    
    .calib-cell { text-align: center; vertical-align: middle; width: 220px; }
  </style>
</head>
<body>

  <h1>‚öôÔ∏è System Einstellungen</h1>

  <!-- Abschnitt A bis E bleiben identisch wie in deinem Code -->
  <h2>A ‚Äì WLAN Access Point</h2>
  <table>
    <tr><td>SSID:</td><td><input type="text" id="ap_ssid"></td></tr>
    <tr><td>Passwort:</td><td><input type="text" id="ap_password"></td></tr>
  </table>

  <h2>B ‚Äì Sensor Abtastraten (Hz)</h2>
  <table>
    <tr><th>Sensor</th><th>Hz</th></tr>
    <tr><td>GPS hz</td> <td><input type="number" id="gpsHz"></td></tr>
    <tr><td>AHRS Steps</td> <td><input type="number" id="ahrsHz"></td></tr>
    <tr><td>MPU Hz</td> <td><input type="number" id="mpuHz"></td></tr>
    <tr><td>Wind Hz</td> <td><input type="number" id="windHz"></td></tr>
    <tr><td>SD Logging /min</td> <td><input type="number" id="sdHz"></td></tr>
    <tr><td>Sensordaten Update / Hz</td><td><input type="number" id="sensorUpdateHz"></td></tr>
  </table>

  <h2>C ‚Äì Navigation / Missweisung</h2>
  <label><input type="checkbox" id="use_decl_compass"> Kompass Missweisung verwenden</label><br>
  <label><input type="checkbox" id="use_decl_wind"> Wind Missweisung verwenden</label><br>

  <h2>D ‚Äì Boots Parameter</h2>
  <table>
    <tr><td>Sensor to Tiefgang (m)</td><td><input type="number" step="0.01" id="wassertiefe_einbau"></td></tr>
    <tr><td>Tiefgang Boot (m)</td><td><input type="number" step="0.01" id="tiefgang_boot"></td></tr>
  </table>

  <h2>E ‚Äì Wasser Parameter</h2>
  <table>
    <tr><td>Wassertemperatur (¬∞C)</td><td><input type="number" id="wassertemperatur"></td></tr>
    <tr><td>Salinit√§t (‚Ä∞)</td><td><input type="number" step="0.1" id="waterSalinity"></td></tr>
  </table>

  <!-- ===================== NEUER ABSCHNITT F: Kalibrierung ===================== -->
  <h2>F ‚Äì Sensor Kalibrierung</h2>
  <table>
    <tr>
      <th colspan="2">Aktion & Anleitung</th>
    </tr>
    <!-- Kompass -->
    <tr>
      <td class="calib-cell">
        <button id="calibCompassBtn" onclick="calibrate('compass')">üß≠ Kompass kalibrieren</button>
      </td>
      <td>
        <strong>Warum?</strong> Korrigiert magnetische St√∂reinfl√ºsse durch das Boot (Eisen, Kabel).<br>
        <strong>Ablauf:</strong> Nach Start ca. 30 Sek. Zeit. Drehen Sie das Boot langsam um 360¬∞ (Vollkreis).<br>
        <span class="info-text">Hinweis: Nur bei ruhigem Wasser und ohne gro√üe Metallschiffe in der N√§he durchf√ºhren.</span>
      </td>
    </tr>
    <!-- Gyro -->
    <tr>
      <td class="calib-cell">
        <button id="calibGyroBtn" onclick="calibrate('gyro')">üîÑ Gyro kalibrieren</button>
      </td>
      <td>
        <strong>Warum?</strong> Verhindert das "Wandern" des Horizonts und verbessert die Kursstabilit√§t.<br>
        <strong>Ablauf:</strong> Das Boot muss w√§hrend der Messung <u>absolut still</u> liegen.<br>
        <span class="info-text">Hinweis: Am besten im Hafen bei Ententeich-Bedingungen durchf√ºhren.</span>
      </td>
    </tr>
  </table>

  <!-- ===================== Haupt-Buttons ===================== -->
  <div class="buttonBar">
    <button id="saveBtn" onclick="saveSystem()">üíæ Einstellungen Speichern</button>
    <button id="cancelBtn" onclick="cancel()">‚ùå Abbrechen</button>
  </div>
<h2>üìÇ Gespeicherte Systemdateien (Filesystem)</h2>

<table>
  <tr>
    <th>Datei</th>
    <th>Inhalt (Read-Only)</th>
  </tr>

  <tr>
    <td>/system_config.json</td>
    <td>
      <textarea id="fs_system"
        rows="10"
        readonly
        style="width:100%; background:#001820; color:#0fd; font-family:monospace;">
Lade‚Ä¶
      </textarea>
    </td>
  </tr>

  <tr>
    <td>/settings/IMU_mag.json</td>
    <td>
      <textarea id="fs_mag"
        rows="8"
        readonly
        style="width:100%; background:#001820; color:#ffd54f; font-family:monospace;">
Lade‚Ä¶
      </textarea>
    </td>
  </tr>

  <tr>
    <td>/settings/IMU_gyro.json</td>
    <td>
      <textarea id="fs_gyro"
        rows="8"
        readonly
        style="width:100%; background:#001820; color:#ff8a80; font-family:monospace;">
Lade‚Ä¶
      </textarea>
    </td>
  </tr>
</table>

  <script>
    // Laden der vorhandenen System Config
    fetch("/getSystem")
      .then(r => r.json())
      .then(cfg => {
        document.getElementById('ap_ssid').value          = cfg.ap_ssid;
        document.getElementById('ap_password').value      = cfg.ap_password;
        document.getElementById('gpsHz').value           = cfg.gps_hz;
        document.getElementById('ahrsHz').value          = cfg.ahrs_hz;
        document.getElementById('mpuHz').value           = cfg.mpu_hz;
        document.getElementById('windHz').value          = cfg.wind_hz;
        document.getElementById('sdHz').value            = cfg.sd_hz;
        document.getElementById('sensorUpdateHz').value  = cfg.sensor_update_hz;
        document.getElementById('use_decl_compass').checked = cfg.use_decl_compass;
        document.getElementById('use_decl_wind').checked    = cfg.use_decl_wind;
        document.getElementById('wassertiefe_einbau').value = cfg.wassertiefe_einbau;
        document.getElementById('tiefgang_boot').value      = cfg.tiefgang_boot;
        document.getElementById('wassertemperatur').value   = cfg.wassertemperatur;
        document.getElementById('waterSalinity').value      = cfg.waterSalinity;
      })
      .catch(() => alert("‚ùå Fehler beim Laden der Konfiguration"));

    function saveSystem() {
      const params = new URLSearchParams({
        ap_ssid: document.getElementById('ap_ssid').value,
        ap_password: document.getElementById('ap_password').value,
        gps_hz: document.getElementById('gpsHz').value,
        ahrs_hz: document.getElementById('ahrsHz').value,
        mpu_hz: document.getElementById('mpuHz').value,
        wind_hz: document.getElementById('windHz').value,
        sd_hz: document.getElementById('sdHz').value,
        sensor_update_hz: document.getElementById('sensorUpdateHz').value,
        use_decl_compass: document.getElementById('use_decl_compass').checked ? 1 : 0,
        use_decl_wind: document.getElementById('use_decl_wind').checked ? 1 : 0,
        wassertiefe_einbau: document.getElementById('wassertiefe_einbau').value,
        tiefgang_boot: document.getElementById('tiefgang_boot').value,
        wassertemperatur: document.getElementById('wassertemperatur').value,
        water_salinity: document.getElementById('waterSalinity').value
      });

      fetch(`/setSystem?${params.toString()}`)
        .then(r => r.text())
        .then(txt => { alert(txt); window.location.href="index.html"; })
        .catch(() => alert("‚ùå Fehler beim Speichern"));
    }

    function cancel() { window.location.href="index.html"; }
	
function calibrate(type) {
  const msg = type === 'compass' 
    ? "KOMPASS: Boot bereit f√ºr 360¬∞ Drehung? (Dauer ca. 30s)" 
    : "GYRO: Liegt das Boot absolut ruhig? (Dauer ca. 3s)";
  
  if (!confirm(msg)) return;

  const btnCompass = document.getElementById('calibCompassBtn');
  const btnGyro = document.getElementById('calibGyroBtn');
  const originalCompassTxt = "üß≠ Kompass kalibrieren";
  const originalGyroTxt = "üîÑ Gyro kalibrieren";

  fetch(`/calibrate?type=${type}`)
    .then(r => r.text())
    .then(txt => {
      alert("Antwort: " + txt);
      
      // Sperrzeiten definieren (Sekunden)
      let waitTime = (type === 'compass') ? 35 : 5;
      
      // UI Sperren
      btnCompass.disabled = true;
      btnGyro.disabled = true;
      btnCompass.style.opacity = "0.5";
      btnGyro.style.opacity = "0.5";

      let timeLeft = waitTime;
      const timer = setInterval(() => {
        timeLeft--;
        
        if (type === 'compass') {
          btnCompass.innerHTML = `‚è≥ Drehen... (${timeLeft}s)`;
        } else {
          btnGyro.innerHTML = `‚è≥ Stillhalten... (${timeLeft}s)`;
        }

        if (timeLeft <= 0) {
          clearInterval(timer);
          btnCompass.disabled = false;
          btnGyro.disabled = false;
          btnCompass.style.opacity = "1";
          btnGyro.style.opacity = "1";
          btnCompass.innerHTML = originalCompassTxt;
          btnGyro.innerHTML = originalGyroTxt;
        }
      }, 1000);
    })
    .catch(() => alert("‚ùå Fehler beim Starten"));
}

function loadFSFile(url, targetId) {
  fetch(url)
    .then(r => {
      if (!r.ok) throw "Datei nicht vorhanden";
      return r.text();
    })
    .then(txt => {
      document.getElementById(targetId).value = txt;
    })
    .catch(() => {
      document.getElementById(targetId).value =
        "‚ùå Datei nicht vorhanden oder leer";
    });
}

// FS Dateien laden
loadFSFile("/fs/system_config", "fs_system");
loadFSFile("/fs/imu_mag", "fs_mag");
loadFSFile("/fs/imu_gyro", "fs_gyro");
</script>

</body>
</html>
